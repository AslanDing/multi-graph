import os.path as osp

import matplotlib.pyplot as plt
import torch
print(torch.__version__)
print(torch.version.cuda)

from sklearn.manifold import TSNE

from torch_geometric.datasets import Planetoid
from torch_geometric.nn import Node2Vec

from scipy.io import loadmat
import numpy as np

batch_size = 64
learning_rate = 0.01
def main():
    data_dir = r'../exp/acm/data'
    data_path = data_dir + r'/ACM_multi_graph.mat'

    datas = loadmat(data_path)

    A11 = datas['PSP']

    train_list = datas['train_idx']
    train_label = datas['train_taget']

    test_list = datas['test_idx']
    test_label = datas['test_taget']

    A11sub = A11.nonzero()
    edge_index = torch.stack([torch.from_numpy(A11sub[0].astype(np.int64)),
                 torch.from_numpy(A11sub[1].astype(np.int64))], dim=0)

    #data = dataset[0]
    device = 'cuda' if torch.cuda.is_available() else 'cpu'
    model = Node2Vec(edge_index, embedding_dim=128, walk_length=20,
                     context_size=10,sparse=True).to(device)
                     #walks_per_node=10, num_negative_samples=1, p=1, q=1, sparse=True).to(device)

    loader = model.loader(batch_size=batch_size, shuffle=True, num_workers=4)
    optimizer = torch.optim.SparseAdam(list(model.parameters()), lr=learning_rate)

    def train():
        model.train()
        total_loss = 0
        #count = 0
        for pos_rw, neg_rw in loader:
            optimizer.zero_grad()
            loss = model.loss(pos_rw.to(device), neg_rw.to(device))
            loss.backward()
            optimizer.step()
            total_loss += loss.item()
            #print(count,loss.item())
            #count += 1
        return total_loss / len(loader)

    @torch.no_grad()
    def test():
        model.eval()
        z = model()
        acc,micro,macro = model.test(z[train_list], torch.from_numpy(train_label.reshape(-1)),
                         z[test_list], torch.from_numpy(test_label.reshape(-1)),
                         max_iter=150)
        return acc,micro,macro
    best_list = []
    bmic_list = []
    bmac_list = []
    for i in range(10):
        best = 0
        bmic = 0
        bmac = 0
        for epoch in range(1, 101):
            loss = train()
            acc,micro,macro = test()
            if acc>best:
                best = acc
            if bmic<micro:
                bmic = micro
            if bmac<macro:
                bmac = macro
            # print(f'Epoch: {epoch:02d}, Loss: {loss:.4f}, Acc: {acc:.4f}, Best:{best:.4f}, bmic:{bmic:.4f}, bmac:{bmac:.4f}')
        best_list.append(best)
        bmic_list.append(bmic)
        bmac_list.append(bmac)

    print(best_list)
    print(np.array(best_list).max())
    print(bmic_list)
    print(np.array(bmic_list).max())
    print(bmac_list)
    print(np.array(bmac_list).max())



if __name__ == "__main__":
    batch_size_list = [32,64,128,256,512]
    learning_rate_list = [0.01,0.005,0.008,0.001,0.0005]
    for batch_size_ in batch_size_list:
        for learning_rate_ in learning_rate_list:
            batch_size = batch_size_
            learning_rate = learning_rate_
            print(batch_size_,learning_rate_)
            main()
            print()

"""
32 0.01
[0.6773584905660377, 0.6698113207547169, 0.6778301886792453, 0.6811320754716981, 0.6783018867924528, 0.6754716981132075, 0.6768867924528302, 0.6688679245283019, 0.6731132075471699, 0.675]
0.6811320754716981
[0.6773584905660377, 0.6698113207547169, 0.6778301886792453, 0.6811320754716981, 0.6783018867924528, 0.6754716981132075, 0.6768867924528302, 0.6688679245283019, 0.6731132075471699, 0.675]
0.6811320754716981
[0.6850927699233952, 0.678461387467198, 0.6845526178767555, 0.6885247303118721, 0.6869618675575632, 0.683822891273273, 0.6839059042616823, 0.6773359242915964, 0.6807476690378836, 0.683979381254013]
0.6885247303118721

32 0.005
[0.6518867924528302, 0.6707547169811321, 0.6745283018867925, 0.6863207547169812, 0.6900943396226416, 0.6863207547169812, 0.6768867924528302, 0.6863207547169812, 0.6792452830188679, 0.6792452830188679]
0.6900943396226416
[0.6518867924528302, 0.6707547169811321, 0.6745283018867925, 0.6863207547169812, 0.6900943396226416, 0.6863207547169812, 0.6768867924528302, 0.6863207547169812, 0.6792452830188679, 0.6792452830188679]
0.6900943396226416
[0.6588493003209192, 0.6768618651828816, 0.6820990421802923, 0.694189196624795, 0.6961332046503467, 0.692641712742172, 0.6844670828649049, 0.6935127255812382, 0.6873903966929239, 0.6870845670928217]
0.6961332046503467

32 0.008
[0.6617924528301887, 0.6764150943396227, 0.6702830188679245, 0.6778301886792453, 0.6778301886792453, 0.6660377358490566, 0.680188679245283, 0.6830188679245283, 0.6759433962264151, 0.6783018867924528]
0.6830188679245283
[0.6617924528301887, 0.6764150943396227, 0.6702830188679245, 0.6778301886792453, 0.6778301886792453, 0.6660377358490566, 0.680188679245283, 0.6830188679245283, 0.6759433962264151, 0.6783018867924528]
0.6830188679245283
[0.6693133608042364, 0.6839017028152833, 0.6769236312180854, 0.6866656269448369, 0.6848648236453099, 0.672845818388057, 0.6865516279433487, 0.6898189053472255, 0.6827228528505248, 0.6867059785100148]
0.6898189053472255

32 0.001
[0.6141509433962264, 0.6311320754716981, 0.6471698113207547, 0.6533018867924528, 0.6627358490566038, 0.6674528301886793, 0.6778301886792453, 0.6787735849056604, 0.6787735849056604, 0.6764150943396227]
0.6787735849056604
[0.6141509433962264, 0.6311320754716981, 0.6471698113207547, 0.6533018867924528, 0.6627358490566038, 0.6674528301886793, 0.6778301886792453, 0.6787735849056604, 0.6787735849056604, 0.6764150943396227]
0.6787735849056604
[0.6201722209491668, 0.6392109777124156, 0.6549995421082725, 0.6595057008073278, 0.6680220979884434, 0.6717077880575979, 0.6798849632961023, 0.6829200404534679, 0.6818994261103088, 0.6800086248754544]
0.6829200404534679

32 0.0005
[0.5707547169811321, 0.6042452830188679, 0.6122641509433963, 0.6212264150943396, 0.6334905660377359, 0.6433962264150943, 0.65, 0.6514150943396226, 0.6566037735849056, 0.6589622641509434]
0.6589622641509434
[0.5707547169811321, 0.6042452830188679, 0.6122641509433963, 0.6212264150943396, 0.6334905660377359, 0.6433962264150943, 0.65, 0.6514150943396226, 0.6566037735849056, 0.6589622641509434]
0.6589622641509434
[0.5746534892869198, 0.6117470253744025, 0.6217796018994068, 0.6311669716098323, 0.6432899042662868, 0.6530307635645701, 0.6586617352539017, 0.6597195047643962, 0.6640437695341802, 0.6654050018368081]
0.6654050018368081

64 0.01
[0.6745283018867925, 0.6702830188679245, 0.6712264150943397, 0.6650943396226415, 0.6721698113207547, 0.6693396226415095, 0.6716981132075471, 0.6863207547169812, 0.6773584905660377, 0.6773584905660377]
0.6863207547169812
[0.6745283018867925, 0.6702830188679245, 0.6712264150943397, 0.6650943396226415, 0.6721698113207547, 0.6693396226415095, 0.6716981132075471, 0.6863207547169812, 0.6773584905660377, 0.6773584905660377]
0.6863207547169812
[0.6822725704859001, 0.67926478239161, 0.6776885079183885, 0.6736158476894699, 0.6810119850568715, 0.6780074591070399, 0.67826409642876, 0.6933280026312377, 0.68529126750991, 0.6846750348764069]
0.6933280026312377

64 0.005
[0.6575471698113208, 0.6655660377358491, 0.6660377358490566, 0.6773584905660377, 0.6849056603773584, 0.6731132075471699, 0.675, 0.6674528301886793, 0.6792452830188679, 0.6806603773584906]
0.6849056603773584
[0.6575471698113208, 0.6655660377358491, 0.6660377358490566, 0.6773584905660377, 0.6849056603773584, 0.6731132075471699, 0.675, 0.6674528301886793, 0.6792452830188679, 0.6806603773584906]
0.6849056603773584
[0.6648843486325181, 0.672164182116045, 0.671839092531883, 0.6836019277188257, 0.6905895317652178, 0.6795976811771242, 0.6824401722987526, 0.6748913303714904, 0.6869685251356366, 0.6878028775356425]
0.6905895317652178

64 0.008
[0.6476415094339623, 0.6698113207547169, 0.6787735849056604, 0.6731132075471699, 0.6792452830188679, 0.680188679245283, 0.6773584905660377, 0.6759433962264151, 0.680188679245283, 0.6778301886792453]
0.680188679245283
[0.6476415094339623, 0.6698113207547169, 0.6787735849056604, 0.6731132075471699, 0.6792452830188679, 0.680188679245283, 0.6773584905660377, 0.6759433962264151, 0.680188679245283, 0.6778301886792453]
0.680188679245283
[0.6544902104583654, 0.6764176647940799, 0.6865280894968068, 0.6805565583323389, 0.6875305997123968, 0.6877915664993021, 0.6848632974397759, 0.6826688854897119, 0.6875210304476896, 0.6851794584542655]
0.6877915664993021

64 0.001
[0.6103773584905661, 0.6344339622641509, 0.6433962264150943, 0.660377358490566, 0.6745283018867925, 0.6693396226415095, 0.6636792452830189, 0.6712264150943397, 0.6702830188679245, 0.6707547169811321]
0.6745283018867925
[0.6103773584905661, 0.6344339622641509, 0.6433962264150943, 0.660377358490566, 0.6745283018867925, 0.6693396226415095, 0.6636792452830189, 0.6712264150943397, 0.6702830188679245, 0.6707547169811321]
0.6745283018867925
[0.6148368810239965, 0.6409127926436212, 0.6508926558762641, 0.6673522028894444, 0.6816195498461748, 0.6762526866649416, 0.671469949180668, 0.6768087631748366, 0.67655261593755, 0.6771378552758738]
0.6816195498461748

64 0.0005
[0.5240566037735849, 0.5933962264150944, 0.6056603773584905, 0.6108490566037735, 0.625, 0.6330188679245283, 0.6419811320754717, 0.6509433962264151, 0.6547169811320754, 0.6599056603773585]
0.6599056603773585
[0.5240566037735849, 0.5933962264150944, 0.6056603773584905, 0.6108490566037735, 0.625, 0.6330188679245283, 0.6419811320754717, 0.6509433962264151, 0.6547169811320754, 0.6599056603773585]
0.6599056603773585
[0.5289443085678976, 0.6005338614799389, 0.614233168291571, 0.6201596824982766, 0.6343226210684897, 0.6422485771571166, 0.6512793941809486, 0.6587529624430063, 0.6620375010001828, 0.6663356448548604]
0.6663356448548604

128 0.01
[0.655188679245283, 0.6735849056603773, 0.6660377358490566, 0.6764150943396227, 0.6735849056603773, 0.6754716981132075, 0.675, 0.6825471698113208, 0.6754716981132075, 0.6764150943396227]
0.6825471698113208
[0.655188679245283, 0.6735849056603773, 0.6660377358490566, 0.6764150943396227, 0.6735849056603773, 0.6754716981132075, 0.675, 0.6825471698113208, 0.6754716981132075, 0.6764150943396227]
0.6825471698113208
[0.6630097231520402, 0.6797822789980973, 0.6725975962873355, 0.6841490393055452, 0.6819263450070129, 0.6831772550194786, 0.683156066123885, 0.6902648289078623, 0.6843010499035151, 0.6848675218081475]
0.6902648289078623

128 0.005
[0.6349056603773585, 0.6589622641509434, 0.6698113207547169, 0.6735849056603773, 0.6707547169811321, 0.6740566037735849, 0.6660377358490566, 0.6773584905660377, 0.675, 0.6731132075471699]
0.6773584905660377
[0.6349056603773585, 0.6589622641509434, 0.6698113207547169, 0.6735849056603773, 0.6707547169811321, 0.6740566037735849, 0.6660377358490566, 0.6773584905660377, 0.675, 0.6731132075471699]
0.6773584905660377
[0.6456313837845314, 0.6681967598872897, 0.6768702783470838, 0.6813724008563966, 0.6797501490966402, 0.6828818861058249, 0.6741238082281594, 0.6842693826311249, 0.682483300945178, 0.6809368155517078]
0.6842693826311249

128 0.008
[0.6622641509433962, 0.6735849056603773, 0.6806603773584906, 0.6745283018867925, 0.6759433962264151, 0.6679245283018868, 0.6768867924528302, 0.6702830188679245, 0.6754716981132075, 0.6745283018867925]
0.6806603773584906
[0.6622641509433962, 0.6735849056603773, 0.6806603773584906, 0.6745283018867925, 0.6759433962264151, 0.6679245283018868, 0.6768867924528302, 0.6702830188679245, 0.6754716981132075, 0.6745283018867925]
0.6806603773584906
[0.6704961245496879, 0.6789106021428579, 0.6881546828841704, 0.6811544658070053, 0.6834465444850496, 0.6759653039038233, 0.6855041010869315, 0.6784374387404591, 0.682834861729774, 0.6830650911694399]
0.6881546828841704

128 0.001
[0.5867924528301887, 0.6099056603773585, 0.6141509433962264, 0.630188679245283, 0.6481132075471698, 0.6561320754716982, 0.6476415094339623, 0.6566037735849056, 0.6617924528301887, 0.6650943396226415]
0.6650943396226415
[0.5867924528301887, 0.6099056603773585, 0.6141509433962264, 0.630188679245283, 0.6481132075471698, 0.6561320754716982, 0.6476415094339623, 0.6566037735849056, 0.6617924528301887, 0.6650943396226415]
0.6650943396226415
[0.5944162910396846, 0.6201819205640585, 0.6245593789987424, 0.640178686421267, 0.6576328990898889, 0.6646868884796466, 0.6563696001930742, 0.6641079877933612, 0.6672738635199864, 0.6704952377703952]
0.6704952377703952

128 0.0005
[0.47735849056603774, 0.5919811320754716, 0.6084905660377359, 0.6160377358490566, 0.6283018867924528, 0.6353773584905661, 0.6391509433962265, 0.644811320754717, 0.6537735849056604, 0.6566037735849056]
0.6566037735849056
[0.47735849056603774, 0.5919811320754716, 0.6084905660377359, 0.6160377358490566, 0.6283018867924528, 0.6353773584905661, 0.6391509433962265, 0.644811320754717, 0.6537735849056604, 0.6566037735849056]
0.6566037735849056
[0.47788645989342954, 0.5977203772929279, 0.6148105966469136, 0.6236253860963137, 0.6362356386087037, 0.6442551674372349, 0.6478631598167585, 0.652813215635848, 0.6608122493267249, 0.6632874563254844]
0.6632874563254844

256 0.01
[0.65, 0.6679245283018868, 0.6792452830188679, 0.6683962264150943, 0.6759433962264151, 0.6731132075471699, 0.6820754716981132, 0.6707547169811321, 0.6731132075471699, 0.6834905660377358]
0.6834905660377358
[0.65, 0.6679245283018868, 0.6792452830188679, 0.6683962264150943, 0.6759433962264151, 0.6731132075471699, 0.6820754716981132, 0.6707547169811321, 0.6731132075471699, 0.6834905660377358]
0.6834905660377358
[0.660379591780558, 0.6758240968955739, 0.6853371589650271, 0.6765180123868454, 0.6819525511219643, 0.6813165650589914, 0.69111040899284, 0.6790851466105973, 0.6807957383076939, 0.6912715307090745]
0.6912715307090745

256 0.005
[0.629245283018868, 0.6556603773584906, 0.6716981132075471, 0.6825471698113208, 0.680188679245283, 0.6778301886792453, 0.6764150943396227, 0.6764150943396227, 0.6830188679245283, 0.6726415094339623]
0.6830188679245283
[0.629245283018868, 0.6556603773584906, 0.6716981132075471, 0.6825471698113208, 0.680188679245283, 0.6778301886792453, 0.6764150943396227, 0.6764150943396227, 0.6830188679245283, 0.6726415094339623]
0.6830188679245283
[0.6391090073982783, 0.6631145937095696, 0.6786503076554581, 0.6886856001741846, 0.686770579623439, 0.6806002046648878, 0.6807102560792478, 0.6832189723496166, 0.6889204179359973, 0.6790166494632129]
0.6889204179359973

256 0.008
[0.6481132075471698, 0.6622641509433962, 0.6787735849056604, 0.6816037735849056, 0.684433962264151, 0.675, 0.6820754716981132, 0.6787735849056604, 0.6712264150943397, 0.6688679245283019]
0.684433962264151
[0.6481132075471698, 0.6622641509433962, 0.6787735849056604, 0.6816037735849056, 0.684433962264151, 0.675, 0.6820754716981132, 0.6787735849056604, 0.6712264150943397, 0.6688679245283019]
0.684433962264151
[0.6564994351919858, 0.6691809572524524, 0.6856528565534612, 0.6876868203595312, 0.6900615101524195, 0.6812061610626553, 0.6885466800483186, 0.6873423643576094, 0.6781999691863375, 0.6764857728586172]
0.6900615101524195

256 0.001
[0.5419811320754717, 0.5976415094339622, 0.6160377358490566, 0.630188679245283, 0.6419811320754717, 0.6570754716981132, 0.6693396226415095, 0.6716981132075471, 0.6721698113207547, 0.6778301886792453]
0.6778301886792453
[0.5419811320754717, 0.5976415094339622, 0.6160377358490566, 0.630188679245283, 0.6419811320754717, 0.6570754716981132, 0.6693396226415095, 0.6716981132075471, 0.6721698113207547, 0.6778301886792453]
0.6778301886792453
[0.5450908705939626, 0.6048862688049732, 0.6241055266585209, 0.6391995767756087, 0.6509675701763508, 0.6653026926988886, 0.6767863551133869, 0.6785921633277711, 0.6785320062819286, 0.6834016699173233]
0.6834016699173233

256 0.0005
[0.42924528301886794, 0.5570754716981132, 0.5915094339622642, 0.5971698113207548, 0.5981132075471698, 0.6009433962264151, 0.6004716981132076, 0.6075471698113207, 0.6150943396226415, 0.625]
0.625
[0.42924528301886794, 0.5570754716981132, 0.5915094339622642, 0.5971698113207548, 0.5981132075471698, 0.6009433962264151, 0.6004716981132076, 0.6075471698113207, 0.6150943396226415, 0.625]
0.625
[0.42978853339914624, 0.5598824176519511, 0.5963967605241979, 0.6026143243650455, 0.6056722800094242, 0.6095876899576614, 0.6106946630352746, 0.6177548681120427, 0.6247810905009353, 0.6343210744124307]
0.6343210744124307

512 0.01
[0.6410377358490567, 0.6650943396226415, 0.6745283018867925, 0.6693396226415095, 0.6792452830188679, 0.6702830188679245, 0.6702830188679245, 0.6712264150943397, 0.6740566037735849, 0.6816037735849056]
0.6816037735849056
[0.6410377358490567, 0.6650943396226415, 0.6745283018867925, 0.6693396226415095, 0.6792452830188679, 0.6702830188679245, 0.6702830188679245, 0.6712264150943397, 0.6740566037735849, 0.6816037735849056]
0.6816037735849056
[0.6470950530775745, 0.6703386420514357, 0.6817656365405459, 0.6766826341756591, 0.684821884670746, 0.6742921698135417, 0.6770752966198886, 0.6794255653012126, 0.6814693361685048, 0.6886780216579885]
0.6886780216579885

512 0.005
[0.6349056603773585, 0.6466981132075472, 0.6575471698113208, 0.6683962264150943, 0.6754716981132075, 0.6759433962264151, 0.6787735849056604, 0.6764150943396227, 0.6783018867924528, 0.6792452830188679]
0.6792452830188679
[0.6349056603773585, 0.6466981132075472, 0.6575471698113208, 0.6683962264150943, 0.6754716981132075, 0.6759433962264151, 0.6787735849056604, 0.6764150943396227, 0.6783018867924528, 0.6792452830188679]
0.6792452830188679
[0.6440830103859367, 0.6560659621237533, 0.6652763396888149, 0.6742376228927176, 0.6802272745544878, 0.6805990008957329, 0.6845747390253129, 0.6805107669035029, 0.6826957990414954, 0.6848943534795957]
0.6848943534795957

512 0.008
[0.6433962264150943, 0.6636792452830189, 0.6702830188679245, 0.6721698113207547, 0.6787735849056604, 0.6811320754716981, 0.6825471698113208, 0.6759433962264151, 0.6792452830188679, 0.6825471698113208]
0.6825471698113208
[0.6433962264150943, 0.6636792452830189, 0.6702830188679245, 0.6721698113207547, 0.6787735849056604, 0.6811320754716981, 0.6825471698113208, 0.6759433962264151, 0.6792452830188679, 0.6825471698113208]
0.6825471698113208
[0.6532770944766936, 0.6728062294144924, 0.6758425972469014, 0.6789905525777137, 0.6823848323619005, 0.685985039410669, 0.688601794011114, 0.6843387542771198, 0.6845185177198546, 0.6887813130807534]
0.6887813130807534

512 0.001
[0.4693396226415094, 0.594811320754717, 0.6099056603773585, 0.6160377358490566, 0.6169811320754717, 0.6216981132075472, 0.6287735849056604, 0.6306603773584906, 0.6377358490566037, 0.6481132075471698]
0.6481132075471698
[0.4693396226415094, 0.594811320754717, 0.6099056603773585, 0.6160377358490566, 0.6169811320754717, 0.6216981132075472, 0.6287735849056604, 0.6306603773584906, 0.6377358490566037, 0.6481132075471698]
0.6481132075471698
[0.4709457770948014, 0.600391105466811, 0.6181800948073511, 0.6260698720072777, 0.626776268614564, 0.6314260460865829, 0.6388929779715701, 0.6409856203374309, 0.6467267513802483, 0.6566642378897285]
0.6566642378897285

512 0.0005
[0.3938679245283019, 0.49150943396226415, 0.5617924528301886, 0.5933962264150944, 0.5971698113207548, 0.6047169811320755, 0.6103773584905661, 0.6146226415094339, 0.6193396226415094, 0.6221698113207547]
0.6221698113207547
[0.3938679245283018, 0.49150943396226415, 0.5617924528301886, 0.5933962264150944, 0.5971698113207548, 0.6047169811320755, 0.6103773584905661, 0.6146226415094339, 0.6193396226415094, 0.6221698113207547]
0.6221698113207547
[0.39449719549958484, 0.4950677607406815, 0.5666267377882731, 0.5988126005321238, 0.6039639233261548, 0.6127723261584984, 0.6191792653274096, 0.6238219387960527, 0.6296477671074073, 0.6327084185652482]
0.6327084185652482
"""
