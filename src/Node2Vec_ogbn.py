import os.path as osp

import matplotlib.pyplot as plt
import torch
print(torch.__version__)
print(torch.version.cuda)

from sklearn.manifold import TSNE

from torch_geometric.nn import Node2Vec

from scipy.io import loadmat
import numpy as np

batch_size = 64
learning_rate = 0.01

def main():
    data_dir = r'../exp/ogbn_mag/data'
    data_path = data_dir + r'/ogbn_mag_graph.mat'

    datas = loadmat(data_path)

    A11 = datas['PCP']

    Paper_Label = datas['PL']

    train_list = datas['train_idx']
    train_label = Paper_Label[train_list[0,:]]

    test_list = datas['test_idx']
    test_label = Paper_Label[test_list[0,:]]

    val_list = datas['val_idx']
    val_label = Paper_Label[val_list[0,:]]

    A11sub = A11.nonzero()
    edge_index = torch.stack([torch.from_numpy(A11sub[0].astype(np.int64)),
                 torch.from_numpy(A11sub[1].astype(np.int64))], dim=0)

    #data = dataset[0]
    device = 'cuda' if torch.cuda.is_available() else 'cpu'
    model = Node2Vec(edge_index, embedding_dim=128, walk_length=20,
                     context_size=10,sparse=True).to(device)
                     #walks_per_node=10, num_negative_samples=1, p=1, q=1, sparse=True).to(device)

    loader = model.loader(batch_size=batch_size, shuffle=True, num_workers=4)
    optimizer = torch.optim.SparseAdam(list(model.parameters()), lr=learning_rate)

    def train():
        model.train()
        total_loss = 0
        #count = 0
        for pos_rw, neg_rw in loader:
            optimizer.zero_grad()
            loss = model.loss(pos_rw.to(device), neg_rw.to(device))
            loss.backward()
            optimizer.step()
            total_loss += loss.item()
            #print(count,loss.item())
            #count += 1
        return total_loss / len(loader)

    @torch.no_grad()
    def test():
        model.eval()
        z = model()
        acc,micro,macro = model.test(z[train_list], torch.from_numpy(train_label.reshape(-1)),
                         z[test_list], torch.from_numpy(test_label.reshape(-1)),
                         max_iter=150)
        return acc,micro,macro
    best_list = []
    bmic_list = []
    bmac_list = []
    for i in range(10):
        best = 0
        bmic = 0
        bmac = 0
        for epoch in range(1, 101):
            loss = train()
            acc,micro,macro = test()
            if acc>best:
                best = acc
            if bmic<micro:
                bmic = micro
            if bmac<macro:
                bmac = macro
            #print(f'Epoch: {epoch:02d}, Loss: {loss:.4f}, Acc: {acc:.4f}, Best:{best:.4f}, bmic:{bmic:.4f}, bmac:{bmac:.4f}')
        best_list.append(best)
        bmic_list.append(bmic)
        bmac_list.append(bmac)

    print(best_list)
    print(np.array(best_list).max())
    print(bmic_list)
    print(np.array(bmic_list).max())
    print(bmac_list)
    print(np.array(bmac_list).max())
""" 
micro_f1  0.3960, bmac:0.3662
"""

if __name__ == "__main__":
    batch_size_list = [32, 64, 128, 256, 512]
    learning_rate_list = [0.01, 0.005, 0.008, 0.001, 0.0005]
    for batch_size_ in batch_size_list:
        for learning_rate_ in learning_rate_list:
            batch_size = batch_size_
            learning_rate = learning_rate_
            print(batch_size_, learning_rate_)
            main()
            print()
"""
32 0.01
[0.3611111111111111, 0.3926553672316384, 0.3818267419962335, 0.3926553672316384, 0.391713747645951, 0.384180790960452, 0.3888888888888889, 0.3822975517890772, 0.3921845574387947, 0.3940677966101695]
0.3940677966101695
[0.3611111111111111, 0.3926553672316384, 0.3818267419962335, 0.3926553672316384, 0.39171374764595096, 0.384180790960452, 0.3888888888888889, 0.38229755178907726, 0.3921845574387947, 0.3940677966101695]
0.3940677966101695
[0.33184501652196474, 0.3591625471505062, 0.3523745158505401, 0.36227395865025186, 0.3624567827236084, 0.35313823393840893, 0.35697338267588996, 0.35521009861637937, 0.36104948063970055, 0.3635478673323584]
0.3635478673323584

32 0.005
[0.3055555555555556, 0.384180790960452, 0.4129001883239171, 0.435969868173258, 0.4331450094161959, 0.4373822975517891, 0.4392655367231638, 0.4491525423728814, 0.4533898305084746, 0.4538606403013183]
0.4538606403013183
[0.3055555555555556, 0.384180790960452, 0.41290018832391706, 0.435969868173258, 0.4331450094161959, 0.4373822975517891, 0.4392655367231638, 0.4491525423728814, 0.4533898305084746, 0.4538606403013183]
0.4538606403013183
[0.28043918079329705, 0.349695973374536, 0.37541744341947625, 0.39732580468997775, 0.39649522969977025, 0.3998127712370397, 0.4012651893432501, 0.41081869483439853, 0.4146406104470254, 0.41917817690035736]
0.41917817690035736

32 0.008
[0.3700564971751412, 0.4001883239171375, 0.397834274952919, 0.4048964218455744, 0.4044256120527307, 0.4209039548022599, 0.4279661016949153, 0.4218455743879473, 0.417608286252354, 0.4232580037664783]
0.4279661016949153
[0.3700564971751412, 0.4001883239171375, 0.397834274952919, 0.4048964218455744, 0.4044256120527307, 0.4209039548022599, 0.4279661016949153, 0.4218455743879473, 0.417608286252354, 0.4232580037664783]
0.4279661016949153
[0.34370558722997807, 0.3708627842329376, 0.3660215450420593, 0.3722717274966973, 0.37151204196458043, 0.384164039411335, 0.3901839498183406, 0.3894471203535671, 0.38791886786203084, 0.39003965065046486]
0.3901839498183406

32 0.001
[0.11534839924670433, 0.134180790960452, 0.1977401129943503, 0.2773069679849341, 0.3436911487758945, 0.3728813559322034, 0.3893596986817326, 0.4152542372881356, 0.4204331450094162, 0.4265536723163842]
0.4265536723163842
[0.11534839924670433, 0.134180790960452, 0.1977401129943503, 0.2773069679849341, 0.3436911487758945, 0.3728813559322034, 0.38935969868173254, 0.4152542372881356, 0.4204331450094162, 0.4265536723163842]
0.4265536723163842
[0.11849016843646334, 0.13669404489421258, 0.19542992411821705, 0.2598198983482293, 0.31621736550190366, 0.3420875468050749, 0.35713000273945517, 0.3799314861383827, 0.38541393755365905, 0.3891559814581971]
0.3891559814581971

32 0.0005
[0.1016949152542373, 0.10922787193973635, 0.11299435028248588, 0.12335216572504708, 0.1445386064030132, 0.17325800376647835, 0.22598870056497175, 0.2777777777777778, 0.3102636534839925, 0.3295668549905838]
0.3295668549905838
[0.10169491525423731, 0.10922787193973635, 0.11299435028248588, 0.12335216572504708, 0.1445386064030132, 0.17325800376647835, 0.22598870056497175, 0.2777777777777778, 0.3102636534839925, 0.3295668549905838]
0.3295668549905838
[0.10033653931589352, 0.10922336134253814, 0.11408021992317034, 0.12564832952538704, 0.14636663320661492, 0.17146016884998921, 0.21671488716401538, 0.2601255799782133, 0.2883241677982735, 0.3048468875803879]
0.3048468875803879

64 0.01
[0.3615819209039548, 0.3785310734463277, 0.3879472693032015, 0.3860640301318267, 0.4001883239171375, 0.3968926553672316, 0.3879472693032015, 0.3888888888888889, 0.3959510357815443, 0.4030131826741996]
0.4030131826741996
[0.3615819209039548, 0.3785310734463277, 0.3879472693032015, 0.3860640301318267, 0.4001883239171375, 0.3968926553672316, 0.3879472693032015, 0.3888888888888889, 0.3959510357815443, 0.4030131826741996]
0.4030131826741996
[0.32992660176448313, 0.34586294972745624, 0.35447574084992006, 0.3510106808962047, 0.3669745786868081, 0.3661669653996148, 0.3591847143475625, 0.35527812706299605, 0.3603048498129409, 0.3689476386331985]
0.3689476386331985

64 0.005
[0.3069679849340866, 0.384180790960452, 0.4119585687382298, 0.4246704331450094, 0.435969868173258, 0.4387947269303202, 0.435969868173258, 0.4425612052730697, 0.4430320150659134, 0.4453860640301318]
0.4453860640301318
[0.3069679849340866, 0.384180790960452, 0.4119585687382298, 0.4246704331450094, 0.435969868173258, 0.4387947269303202, 0.435969868173258, 0.4425612052730697, 0.4430320150659134, 0.4453860640301318]
0.4453860640301318
[0.2869125775824745, 0.3549844150581706, 0.37603728395410113, 0.38808989172588404, 0.39731115171844966, 0.4002633492995253, 0.3984321878657878, 0.40977535003127424, 0.4064680163625624, 0.4048438554026831]
0.40977535003127424

64 0.008
[0.3578154425612053, 0.3898305084745763, 0.410075329566855, 0.3992467043314501, 0.3950094161958569, 0.4067796610169492, 0.4147834274952919, 0.4114877589453861, 0.422316384180791, 0.4180790960451977]
0.422316384180791
[0.3578154425612053, 0.3898305084745763, 0.410075329566855, 0.3992467043314501, 0.3950094161958569, 0.40677966101694923, 0.41478342749529185, 0.4114877589453861, 0.422316384180791, 0.4180790960451977]
0.422316384180791
[0.33111181636426734, 0.3562696473013477, 0.3781203497458563, 0.3689352376720229, 0.36052861143383463, 0.37272412689205103, 0.38106729370948794, 0.38107143225622553, 0.3892260073588951, 0.3820938130437644]
0.3892260073588951

64 0.001
[0.10734463276836158, 0.12335216572504708, 0.1817325800376648, 0.2565913370998117, 0.3130885122410546, 0.3540489642184557, 0.3822975517890772, 0.3964218455743879, 0.4044256120527307, 0.4218455743879473]
0.4218455743879473
[0.10734463276836158, 0.12335216572504708, 0.18173258003766476, 0.2565913370998117, 0.3130885122410546, 0.3540489642184557, 0.38229755178907726, 0.3964218455743879, 0.4044256120527307, 0.4218455743879473]
0.4218455743879473
[0.10652989671393942, 0.12383691353886694, 0.17887905613017016, 0.24144024812277992, 0.2875712091092337, 0.32627260327894625, 0.35118584459678875, 0.3648676446246798, 0.37133552289696825, 0.3875926309862866]
0.3875926309862866

64 0.0005
[0.10875706214689265, 0.1115819209039548, 0.11958568738229755, 0.13512241054613935, 0.15772128060263654, 0.1869114877589454, 0.24293785310734464, 0.2966101694915254, 0.327683615819209, 0.3535781544256121]
0.3535781544256121
[0.10875706214689264, 0.1115819209039548, 0.11958568738229754, 0.13512241054613935, 0.15772128060263654, 0.18691148775894542, 0.24293785310734464, 0.2966101694915254, 0.327683615819209, 0.3535781544256121]
0.3535781544256121
[0.10893056554888347, 0.11241898321917851, 0.12170729008187513, 0.1375488831749701, 0.16013099803413394, 0.18552818997516743, 0.2327594319489017, 0.27660332487961825, 0.30265310955072694, 0.3247589840011896]
0.3247589840011896

128 0.01
[0.3700564971751412, 0.3761770244821092, 0.3837099811676083, 0.3992467043314501, 0.3940677966101695, 0.3935969868173258, 0.3954802259887006, 0.3926553672316384, 0.3926553672316384, 0.4086629001883239]
0.4086629001883239
[0.3700564971751412, 0.37617702448210927, 0.3837099811676083, 0.3992467043314501, 0.3940677966101695, 0.39359698681732574, 0.3954802259887006, 0.3926553672316384, 0.3926553672316384, 0.4086629001883239]
0.4086629001883239
[0.33654203594033893, 0.3458249984413449, 0.35398401460044143, 0.3681437642925472, 0.3625686533217479, 0.3620026985415807, 0.3626139527644099, 0.36260843617005706, 0.3594369193062287, 0.374927799221908]
0.374927799221908

128 0.005
[0.2970809792843691, 0.3804143126177024, 0.4096045197740113, 0.4204331450094162, 0.4397363465160075, 0.4369114877589454, 0.4533898305084746, 0.4571563088512241, 0.4435028248587571, 0.4373822975517891]
0.4571563088512241
[0.2970809792843691, 0.3804143126177025, 0.4096045197740113, 0.4204331450094162, 0.4397363465160075, 0.4369114877589454, 0.4533898305084746, 0.45715630885122405, 0.4435028248587571, 0.4373822975517891]
0.45715630885122405
[0.27769498626164824, 0.3504040445154743, 0.37844610457387606, 0.3839130379201453, 0.3992226185819123, 0.39635371829313193, 0.41765249143772165, 0.4182469952620658, 0.41051900342945197, 0.39981050093711046]
0.4182469952620658

128 0.008
[0.346045197740113, 0.3808851224105461, 0.3950094161958569, 0.4081920903954802, 0.4110169491525424, 0.4114877589453861, 0.4133709981167608, 0.4147834274952919, 0.4138418079096045, 0.417608286252354]
0.417608286252354
[0.346045197740113, 0.3808851224105461, 0.3950094161958569, 0.40819209039548016, 0.41101694915254233, 0.4114877589453861, 0.4133709981167608, 0.41478342749529185, 0.4138418079096045, 0.417608286252354]
0.417608286252354
[0.31651410357014187, 0.3486341388831297, 0.3685126193663323, 0.3771250766774073, 0.38265231506895514, 0.3843424868548784, 0.38494287444186337, 0.3840806076896161, 0.3805781754512867, 0.380939076308873]
0.38494287444186337

128 0.001
[0.11864406779661017, 0.13465160075329566, 0.18361581920903955, 0.2570621468926554, 0.3319209039548023, 0.3667608286252354, 0.3870056497175141, 0.4011299435028249, 0.4218455743879473, 0.4284369114877589]
0.4284369114877589
[0.11864406779661017, 0.13465160075329566, 0.18361581920903955, 0.2570621468926554, 0.3319209039548023, 0.36676082862523546, 0.3870056497175141, 0.4011299435028249, 0.4218455743879473, 0.4284369114877589]
0.4284369114877589
[0.12139819388524024, 0.13702951928395057, 0.18075247138545786, 0.24212089132834302, 0.3040336289674893, 0.33598906307964327, 0.35466956370957714, 0.3694295181514281, 0.3924635451624616, 0.3954666123428846]
0.3954666123428846


128 0.0005
[0.10969868173258004, 0.1120527306967985, 0.11817325800376648, 0.12994350282485875, 0.1492467043314501, 0.192090395480226, 0.23163841807909605, 0.2735404896421846, 0.3093220338983051, 0.3380414312617702]
0.3380414312617702
[0.10969868173258004, 0.1120527306967985, 0.11817325800376648, 0.12994350282485875, 0.1492467043314501, 0.192090395480226, 0.23163841807909602, 0.2735404896421846, 0.3093220338983051, 0.3380414312617702]
0.3380414312617702
[0.11021398089709877, 0.11331538179609095, 0.12023892775058849, 0.13176417077619412, 0.15193666541829348, 0.19092175443896992, 0.22354665113556757, 0.25681106784805074, 0.28875383631398605, 0.31433706212935275]
0.31433706212935275

256 0.01
[0.3545197740112994, 0.3935969868173258, 0.3954802259887006, 0.3931261770244821, 0.4067796610169492, 0.4077212806026365, 0.3935969868173258, 0.3935969868173258, 0.3855932203389831, 0.4011299435028249]
0.4077212806026365
[0.3545197740112994, 0.39359698681732574, 0.3954802259887006, 0.3931261770244821, 0.40677966101694923, 0.4077212806026365, 0.39359698681732574, 0.39359698681732574, 0.3855932203389831, 0.4011299435028249]
0.4077212806026365
[0.3261821701122235, 0.36220290330379046, 0.3631096411841076, 0.3564812014693899, 0.37155224529018216, 0.37244863320976074, 0.36343885988283314, 0.3616545393243518, 0.3559937553355921, 0.36980841694934885]
0.37244863320976074

256 0.005
[0.275894538606403, 0.3644067796610169, 0.3931261770244821, 0.4157250470809793, 0.4246704331450094, 0.4505649717514124, 0.4519774011299435, 0.4510357815442561, 0.4519774011299435, 0.4576271186440678]
0.4576271186440678
[0.275894538606403, 0.3644067796610169, 0.3931261770244821, 0.41572504708097924, 0.4246704331450094, 0.4505649717514124, 0.4519774011299435, 0.4510357815442561, 0.4519774011299435, 0.4576271186440678]
0.4576271186440678
[0.2580970698063558, 0.33555328636557485, 0.3612838590907208, 0.3825565065846129, 0.3879239904494168, 0.4137453572722145, 0.41547167856323747, 0.4137784368989818, 0.41503623002231427, 0.4166199898397112]
0.4166199898397112

256 0.008
[0.3493408662900188, 0.3822975517890772, 0.3987758945386064, 0.4138418079096045, 0.4133709981167608, 0.4091337099811676, 0.4213747645951036, 0.4194915254237288, 0.4129001883239171, 0.4199623352165725]
0.4213747645951036
[0.3493408662900188, 0.38229755178907726, 0.3987758945386064, 0.4138418079096045, 0.4133709981167608, 0.4091337099811676, 0.4213747645951036, 0.4194915254237288, 0.41290018832391706, 0.4199623352165725]
0.4213747645951036
[0.3252878856445883, 0.3493035045546402, 0.3665109761935523, 0.3797121502590195, 0.38223832662858725, 0.371778198982995, 0.3860314927063927, 0.3878973705300452, 0.382614427369364, 0.38647625869374364]
0.3878973705300452

256 0.001
[0.12146892655367232, 0.13559322033898305, 0.1638418079096045, 0.23116760828625235, 0.2980225988700565, 0.346045197740113, 0.3714689265536723, 0.3959510357815443, 0.4105461393596987, 0.4246704331450094]
0.4246704331450094
[0.12146892655367232, 0.13559322033898305, 0.1638418079096045, 0.23116760828625235, 0.2980225988700565, 0.346045197740113, 0.37146892655367225, 0.3959510357815443, 0.4105461393596987, 0.4246704331450094]
0.4246704331450094
[0.12200490464066056, 0.1381661044796482, 0.16480354271805292, 0.22282955318694478, 0.2794457978203584, 0.31988023314424213, 0.3445591190444438, 0.3692754922909396, 0.37727272246681914, 0.389900832374264]
0.389900832374264

256 0.0005
[0.09227871939736347, 0.09934086629001883, 0.1059322033898305, 0.11911487758945385, 0.13559322033898305, 0.1690207156308851, 0.22080979284369115, 0.2716572504708098, 0.3107344632768362, 0.3333333333333333]
0.3333333333333333
[0.09227871939736347, 0.09934086629001883, 0.1059322033898305, 0.11911487758945384, 0.13559322033898305, 0.1690207156308851, 0.22080979284369115, 0.2716572504708098, 0.3107344632768362, 0.3333333333333333]
0.3333333333333333
[0.09275603361358006, 0.10101596735040157, 0.1084049842230245, 0.12214620191780776, 0.13818602485089637, 0.16900742238179906, 0.21405704194572656, 0.25490041238813793, 0.286968806071006, 0.3078456964178179]
0.3078456964178179

512 0.01
[0.333804143126177, 0.384180790960452, 0.3893596986817326, 0.3907721280602637, 0.3931261770244821, 0.4001883239171375, 0.3926553672316384, 0.4006591337099812, 0.4110169491525424, 0.4025423728813559]
0.4110169491525424
[0.333804143126177, 0.384180790960452, 0.38935969868173254, 0.3907721280602637, 0.3931261770244821, 0.4001883239171375, 0.3926553672316384, 0.4006591337099812, 0.41101694915254233, 0.4025423728813559]
0.41101694915254233
[0.30657372944705086, 0.35336674684550057, 0.35590114092369507, 0.36062650651143074, 0.362870733550788, 0.36562641774880056, 0.3621377989584287, 0.36972816139216125, 0.37589575216440796, 0.3671425099047088]
0.37589575216440796

512 0.005
[0.2523540489642185, 0.3738229755178908, 0.3992467043314501, 0.4289077212806026, 0.4378531073446328, 0.4378531073446328, 0.4595103578154426, 0.4623352165725047, 0.4590395480225989, 0.4599811676082863]
0.4623352165725047
[0.2523540489642185, 0.37382297551789084, 0.3992467043314501, 0.4289077212806026, 0.43785310734463273, 0.43785310734463273, 0.4595103578154426, 0.4623352165725047, 0.4590395480225989, 0.4599811676082862]
0.4623352165725047
[0.24124291374463538, 0.3457019872572838, 0.3701388800450459, 0.38980872664177085, 0.39903641002934237, 0.4018962915719282, 0.41851337078630885, 0.4221037801154873, 0.42121670713428133, 0.420675453459953]
0.4221037801154873

512 0.008
[0.3243879472693032, 0.3912429378531073, 0.4020715630885122, 0.4048964218455744, 0.4063088512241055, 0.4063088512241055, 0.4129001883239171, 0.4114877589453861, 0.4152542372881356, 0.4227871939736347]
0.4227871939736347
[0.3243879472693032, 0.3912429378531073, 0.4020715630885122, 0.4048964218455744, 0.4063088512241055, 0.4063088512241055, 0.41290018832391706, 0.4114877589453861, 0.4152542372881356, 0.4227871939736347]
0.4227871939736347
[0.2971921072703931, 0.3594478200778853, 0.36807453990414885, 0.37253058275151296, 0.37277375183529954, 0.37021508449499835, 0.37942726968016455, 0.37575093596555664, 0.38053789458926157, 0.3883955301935293]
0.3883955301935293

512 0.001
[0.11864406779661017, 0.1322975517890772, 0.1553672316384181, 0.2226930320150659, 0.2975517890772128, 0.3474576271186441, 0.3757062146892655, 0.3964218455743879, 0.4171374764595104, 0.4303201506591337]
0.4303201506591337
[0.11864406779661017, 0.1322975517890772, 0.1553672316384181, 0.2226930320150659, 0.2975517890772128, 0.3474576271186441, 0.3757062146892655, 0.3964218455743879, 0.4171374764595104, 0.4303201506591337]
0.4303201506591337
[0.12012864415180886, 0.1352930368343068, 0.15730796869642338, 0.2154594501803823, 0.27753429107827027, 0.3220263173626131, 0.34750536363551626, 0.3664026903306407, 0.38474621565285305, 0.3982268634557733]
0.3982268634557733

512 0.0005
[0.10922787193973635, 0.11440677966101695, 0.12146892655367232, 0.12429378531073447, 0.13559322033898305, 0.15254237288135594, 0.1906779661016949, 0.2344632768361582, 0.2791902071563089, 0.3177966101694915]
0.3177966101694915
[0.10922787193973635, 0.11440677966101695, 0.12146892655367232, 0.12429378531073447, 0.13559322033898305, 0.15254237288135594, 0.1906779661016949, 0.2344632768361582, 0.2791902071563089, 0.3177966101694915]
0.3177966101694915
[0.10898831269422186, 0.1148288318881783, 0.1225292564245876, 0.1256454939578505, 0.1370955087095985, 0.1524143693473891, 0.18645132666682612, 0.22288438023096724, 0.25912246958248925, 0.29211150567549143]
0.29211150567549143

"""
